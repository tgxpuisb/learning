最近在研究nodejs的vm模块，看了文档介绍，介绍中描述该模块主要提供了一个沙箱环境来运行不受信任的JS代码，对JS代码进行隔离。

于是人们使用该模块来执行那些由用户提供的代码，比如远程数据mock平台，可视化页面搭建平台，在线编程平台等等。

在文档中的安全与隔离两个字激起了我强烈的探究兴趣，真的有安全的环境么，代码层面的隔离真的就无法穿透么，是否存在一些能够方法能够对这些代码项目造成一些麻烦呢？答案是有，而且还很多，下面我们来以一个轻松的故事来向大家展示nodejs的vm模块存在的一些隐患。

现在，假设某创业公司有了一个传说中能改变世界的想法，就差一个程序员了，于是老板找来了程序员小萌，老板给了程序员小萌一个这样的需求，需要在编程教育平台上面提供一个能够让用户上传代码在线解题的功能。

小萌一想，这需求简单，使用vm模块提供的沙箱来运行代码就好了，然后把结果返回给用户，于是哒哒哒开始了编码。很快功能上线，功能体验还不错，业务数据增长也很不错，可是就在这个时候，小萌的公司被竞争对手盯上了，于是他们开始恶意进行破坏，这让小萌他们苦不堪言。

此时我们不妨假设自己就是这个攻击者，看看我们对于这种情况我们能做点什么破坏，同时如果我们是小萌，我们能做些怎么样的防护。小萌实现该功能的模块代码如下：

[图]

文中列出了一个简单的执行沙箱代码的，感兴趣的同学可以尝试下，如果我们正常输入`return 1+1`，能够得到返回的结果是`2`

[图]

接下来，我们尝试些厉害的，比如输入`while(1){}`，这可不得了了，若干秒过去了你会发现这个请求一直处于pending状态，如果你去node那一层看，你一会发现系统跑了一个死循环，其他的请求都不再处理了

[图]

接下来，我们试试`return typeof require`和`return typeof process`看看，得到的结果如下：看样子node确实做了一些隔离，没有能够拿到沙箱外层的上下文变量。

[图]

没关系，让我们回过头来想一想，一些JS代码的基础，如果我们想要代码是执行在上下文环境下的，那么最常用的是使用eval，和Function构造函数。整个代码分为了沙箱上下文和沙箱外的上下文环境，那么有没有什么方法是能够在沙箱里面拿到外面上下文的呢？乍看之下是没有的，但是如果细细想来，沙箱的上下文环境是一个对象，这个对象是从外面传递进来的，对象的`constructor`是`Object`，而`Object`的`constructor`就是Function了，于是我们做一个尝试`return this.constructor.constructor("return typeof process")()`此时我们惊讶的得到了一个object，而这个object正是来自外层上下文的。

[图]

于是我们有了一个套路`this.constructor.constructor(恶意代码)()`，拿到了外层权限，你几乎就相当于拿到了当前这个node进程的权限了，此时我们随意执行一个`this.constructor.constructor("process.exit()")()`神奇的事情发生了，我们在前端就关闭了这个node进程。试想，如果你调用的是其他代码如`this.constructor.constructor("require('child_process').execSync('rm -rf /')")()`假设你对该node进程给的是root权限，那么后果将不堪设想。

[图]

如果你要说上面的太暴力的话，我们还可以来点轻松点的，我们可以看到，上下文中引入了一个lib库，这个lib本来是为了方便开发者的，但是根据JS的引用机制，于是我们又学坏了，我们往这个lib库上面挂载自己的数据，比如`lib.hehe=new Array(5*1000*1000)`，可别小看这行代码，这行代码能够让你的node进程开辟大约45M的内存，假设你的lib上面有一个方法，我们把这个发放装饰一下，然后其他用户在调用的时候，就会不知不觉给你添加内存，而还很难被发现，要知道一个node进程能使用的内存是有上限的，超出了就会内存溢出崩溃，你就等着每隔一段时间重启下服务器吧。

[图]

由于搞出了一系列重大故障，小萌被老板开掉了，老板找了号称高级工程师的小明，现在我们也切换一下视角看一下以上的攻击该如何防御吧。

首先我们要把最大的那个能够获取外层上下文的漏洞堵上，让我们回想一下那方法是通过获取对象的构造函数的构造函数拿到的外层上下文，但是如果一开始环境就没有构造函数呢？有一种方法能够做到就是使用`Object.create(null)`创造出来的对象做为上下文，此时该对象是没有`constructor`的，于是我们暂时堵住了漏洞，那么针对死循环的情况怎么办呢~，通过阅读文档，我们可以给在沙箱配置执行代码的时的timeout。针对内存溢出的问题，我们可以做什么呢，我们可以简单的使用`Object.freeze(lib)`这样的方法，把这个对象给冻结住，防止对象上的内容被篡改。通过以上简单的三招，我们暂时堵住了这些漏洞，当然，还有只是暂时堵住了还有很多未知的或者更复杂的攻击方式需要我们防御。

这个时候大家可能要问了，nodejs的vm模块这么不方便使用呀，还有那么多漏洞，这个时候就要给大家介绍一个非常好用的第三方工具库了，`vm2`https://github.com/patriksimek/vm2，初看你可能会认为这个库是`vm`的升级版，是也不完全是，这个库是第三方开发的，基于nodejs的vm库，将所有存在的漏洞全部堵上了。部分使用的方法的原理我们上面也有讲到，此外他还对传入的对象进行Proxy设置，防止了从程序外部进行写操作的同时也不会影响程序内部的写入操作。允许使用更安全的process、require等环境变量（被修改过了）。打开issue，能看到非常多的人提出问题和BUG并且得到了修复，所以我们可以认为如果你没有精力去关注如何防范这些不受信任的代码，使用vm2模块是一个非常不错的选择。

最后再说说隔离性的问题，所谓的隔离也只的是代码层面，这种隔离很弱。个人认为隔离效果从高到低大致可以如下：物理机器隔离>虚拟机隔离>docker容器隔离>进程间隔离>代码层面隔离。所以上述问题还可以从隔离性的层面进行优化，比如单独给这些要执行代码的模块一个进程去跑，并且给这个进程一个安全的权限。使用docker隔离，甚至使用微服务的思想，把这个模块本身做成一个服务等等。总的来说就一句话，没有安全的代码，只有安全的工程师。在防范危险上面的探索是无止境的。

最后，各位小伙伴们的公司有没有一些类似这样功能的项目呢？如果有，存在这些问题么？在不影响线上服务的情况下，大家也可以去多多尝试一些捣乱的方法看看安全性如何。最后还可以和相应的开发者一起去改善应用，让它更加的安全。

